#!/usr/bin/env python
import os
import subprocess

def main():
    module = AnsibleModule(
        argument_spec=dict(
            data_path=dict(required=True),
        ),
    )

    data_path = module.params['data_path']

    if not os.path.exists(data_path):
        module.fail_json(msg='Data path does not exist')

    if not os.path.isdir(data_path):
        module.fail_json(msg='Data path is not directory')

    changed = False

    if not os.path.exists(os.path.join(data_path, 'magic')):
        subprocess.check_call(['ceph-disk', 'prepare', data_path])
        changed = True

    if not os.path.exists(os.path.join(data_path, 'active')):
        subprocess.check_call(['ceph-disk', 'activate', data_path])
        changed = True

    module.exit_json(changed=changed)

from ansible.module_utils.basic import *

if __name__ == '__main__':
    main()
